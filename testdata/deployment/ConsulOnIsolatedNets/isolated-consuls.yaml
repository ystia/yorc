tosca_definitions_version: tosca_simple_yaml_1_0_0_wd03
description: Alien4Cloud generated service template
template_name: IsolatedConsuls
template_version: 0.1.0-SNAPSHOT
template_author: admin

imports:
  - openstack-types: <janus-openstack-types.yml>
  - consul-types: consul/consul-types.yaml

topology_template:
  node_templates:
    NetworkDC1:
      type: janus.nodes.openstack.Network
      properties:
        ip_version: 4
        cidr: 10.0.0.0/24
        network_name: consul_dc1_network
    NetworkDC2:
      type: janus.nodes.openstack.Network
      properties:
        ip_version: 4
        cidr: 10.0.1.0/24
        network_name: consul_dc2_network

    ConsulAgentDC1:
      type: starlings.nodes.Consul
      properties:
        datacenter: dc1
      requirements:
        - host:
            node: ComputeConsulAgentDC1
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - server_endpoint:
            node: ConsulServerDC1
            capability: starlings.capabilities.ConsulServer
            relationship: starlings.relationships.ConnectsConsulAgentToServer
    ComputeConsulAgentDC1:
      type: janus.nodes.openstack.Compute
      properties:
        user: ubuntu
        flavor: 2
        image: b3a66fe8-473f-43ce-9979-1dc0a5f01dda
        availability_zone: r423-03.share.ops
        key_pair: janus
      requirements:
        - network:
            node: NetworkDC1
            capability: tosca.capabilities.Connectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: private_starlings
        scalable:
          properties:
            max_instances: 1
            min_instances: 1
            default_instances: 1
    FIPConsulServerDC1:
      type: janus.nodes.openstack.FloatingIP
      properties:
        floating_network_name: Public_Network
    ConsulServerDC1:
      type: starlings.nodes.Consul
      properties:
        datacenter: dc1
      requirements:
        - host:
            node: ComputeConsulServerDC1
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
    ComputeConsulServerDC1:
      type: janus.nodes.openstack.Compute
      properties:
        user: ubuntu
        flavor: 2
        image: b3a66fe8-473f-43ce-9979-1dc0a5f01dda
        availability_zone: r423-03.share.ops
        key_pair: janus
      requirements:
        - network:
            node: FIPConsulServerDC1
            capability: janus.capabilities.openstack.FIPConnectivity
        - network:
            node: NetworkDC1
            capability: tosca.capabilities.Connectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: private_starlings
        scalable:
          properties:
            max_instances: 1
            min_instances: 1
            default_instances: 1
    ConsulAgentDC2:
      type: starlings.nodes.Consul
      properties:
        datacenter: dc2
      requirements:
        - host:
            node: ComputeConsulAgentDC2
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - server_endpoint:
            node: ConsulServerDC2
            capability: starlings.capabilities.ConsulServer
            relationship: starlings.relationships.ConnectsConsulAgentToServer
    ComputeConsulAgentDC2:
      type: janus.nodes.openstack.Compute
      properties:
        user: ubuntu
        flavor: 2
        image: b3a66fe8-473f-43ce-9979-1dc0a5f01dda
        availability_zone: r423-03.share.ops
        key_pair: janus
      requirements:
        - network:
            node: NetworkDC2
            capability: tosca.capabilities.Connectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: private_starlings
        scalable:
          properties:
            max_instances: 1
            min_instances: 1
            default_instances: 1
    FIPConsulServerDC2:
      type: janus.nodes.openstack.FloatingIP
      properties:
        floating_network_name: Public_Network
    ConsulServerDC2:
      type: starlings.nodes.Consul
      properties:
        datacenter: dc2
      requirements:
        - host:
            node: ComputeConsulServerDC2
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - wan_endpoint:
            node: ConsulServerDC1
            capability: starlings.capabilities.ConsulServerWAN
            relationship: starlings.relationships.ConnectsConsulServerWAN
    ComputeConsulServerDC2:
      type: janus.nodes.openstack.Compute
      properties:
        user: ubuntu
        flavor: 2
        image: b3a66fe8-473f-43ce-9979-1dc0a5f01dda
        availability_zone: r423-03.share.ops
        key_pair: janus
      requirements:
        - network:
            node: FIPConsulServerDC2
            capability: janus.capabilities.openstack.FIPConnectivity
        - network:
            node: NetworkDC2
            capability: tosca.capabilities.Connectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: private_starlings
        scalable:
          properties:
            max_instances: 1
            min_instances: 1
            default_instances: 1
  workflows:
    install:
      steps:
        NetworkDC1_install:
          node: NetworkDC1
          activity:
            delegate: install
          on-success:
            - ComputeConsulServerDC1_install
            - ComputeConsulAgentDC1_install
        FIPConsulServerDC1_install:
          node: FIPConsulServerDC1
          activity:
            delegate: install
          on-success:
            - ComputeConsulServerDC1_install
        ComputeConsulServerDC1_install:
          node: ComputeConsulServerDC1
          activity:
            delegate: install
          on-success:
            - ConsulServerDC1_initial
        ComputeConsulAgentDC1_install:
          node: ComputeConsulAgentDC1
          activity:
            delegate: install
          on-success:
            - ConsulAgentDC1_initial
        ConsulAgentDC1_initial:
          node: ConsulAgentDC1
          activity:
            set_state: initial
          on-success:
            - ConsulAgentDC1_creating
        ConsulAgentDC1_creating:
          node: ConsulAgentDC1
          activity:
            set_state: creating
          on-success:
            - create_ConsulAgentDC1
        create_ConsulAgentDC1:
          node: ConsulAgentDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulAgentDC1_created
        pre_conf_ConsulAgentDC1/1:
          node: ConsulAgentDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Configure.pre_configure_source/1
          on-success:
            - configure_ConsulAgentDC1
        ConsulAgentDC1_created:
          node: ConsulAgentDC1
          activity:
            set_state: created
          on-success:
            - ConsulAgentDC1_configuring
            - ConsulServerDC1_configuring
        ConsulAgentDC1_configuring:
          node: ConsulAgentDC1
          activity:
            set_state: configuring
          on-success:
            - pre_conf_ConsulAgentDC1/1
        configure_ConsulAgentDC1:
          node: ConsulAgentDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulAgentDC1_configured
        ConsulAgentDC1_configured:
          node: ConsulAgentDC1
          activity:
            set_state: configured
          on-success:
            - ConsulAgentDC1_starting
        ConsulAgentDC1_starting:
          node: ConsulAgentDC1
          activity:
            set_state: starting
          on-success:
            - start_ConsulAgentDC1
        start_ConsulAgentDC1:
          node: ConsulAgentDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulAgentDC1_started
        ConsulAgentDC1_started:
          node: ConsulAgentDC1
          activity:
            set_state: started
        ConsulServerDC1_initial:
          node: ConsulServerDC1
          activity:
            set_state: initial
          on-success:
            - ConsulServerDC1_creating
        ConsulServerDC1_creating:
          node: ConsulServerDC1
          activity:
            set_state: creating
          on-success:
            - create_ConsulServerDC1
        create_ConsulServerDC1:
          node: ConsulServerDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulServerDC1_created
        ConsulServerDC1_created:
          node: ConsulServerDC1
          activity:
            set_state: created
          on-success:
            - ConsulServerDC1_configuring
        ConsulServerDC1_configuring:
          node: ConsulServerDC1
          activity:
            set_state: configuring
          on-success:
            - configure_ConsulServerDC1
        configure_ConsulServerDC1:
          node: ConsulServerDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulServerDC1_configured
        ConsulServerDC1_configured:
          node: ConsulServerDC1
          activity:
            set_state: configured
          on-success:
            - ConsulServerDC1_starting
        ConsulServerDC1_starting:
          node: ConsulServerDC1
          activity:
            set_state: starting
          on-success:
            - start_ConsulServerDC1
        start_ConsulServerDC1:
          node: ConsulServerDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulServerDC1_started
        ConsulServerDC1_started:
          node: ConsulServerDC1
          activity:
            set_state: started
          on-success:
            - ConsulAgentDC1_configuring
            - ConsulServerDC2_configuring
        NetworkDC2_install:
          node: NetworkDC2
          activity:
            delegate: install
          on-success:
            - ComputeConsulServerDC2_install
            - ComputeConsulAgentDC2_install
        FIPConsulServerDC2_install:
          node: FIPConsulServerDC2
          activity:
            delegate: install
          on-success:
            - ComputeConsulServerDC2_install
        ComputeConsulServerDC2_install:
          node: ComputeConsulServerDC2
          activity:
            delegate: install
          on-success:
            - ConsulServerDC2_initial
        ComputeConsulAgentDC2_install:
          node: ComputeConsulAgentDC2
          activity:
            delegate: install
          on-success:
            - ConsulAgentDC2_initial
        ConsulAgentDC2_initial:
          node: ConsulAgentDC2
          activity:
            set_state: initial
          on-success:
            - ConsulAgentDC2_creating
        ConsulAgentDC2_creating:
          node: ConsulAgentDC2
          activity:
            set_state: creating
          on-success:
            - create_ConsulAgentDC2
        create_ConsulAgentDC2:
          node: ConsulAgentDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulAgentDC2_created
        pre_conf_ConsulAgentDC2/1:
          node: ConsulAgentDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Configure.pre_configure_source/1
          on-success:
            - configure_ConsulAgentDC2
        ConsulAgentDC2_created:
          node: ConsulAgentDC2
          activity:
            set_state: created
          on-success:
            - ConsulAgentDC2_configuring
            - ConsulServerDC2_configuring
        ConsulAgentDC2_configuring:
          node: ConsulAgentDC2
          activity:
            set_state: configuring
          on-success:
            - pre_conf_ConsulAgentDC2/1
        configure_ConsulAgentDC2:
          node: ConsulAgentDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulAgentDC2_configured
        ConsulAgentDC2_configured:
          node: ConsulAgentDC2
          activity:
            set_state: configured
          on-success:
            - ConsulAgentDC2_starting
        ConsulAgentDC2_starting:
          node: ConsulAgentDC2
          activity:
            set_state: starting
          on-success:
            - start_ConsulAgentDC2
        start_ConsulAgentDC2:
          node: ConsulAgentDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulAgentDC2_started
        ConsulAgentDC2_started:
          node: ConsulAgentDC2
          activity:
            set_state: started
        ConsulServerDC2_initial:
          node: ConsulServerDC2
          activity:
            set_state: initial
          on-success:
            - ConsulServerDC2_creating
        ConsulServerDC2_creating:
          node: ConsulServerDC2
          activity:
            set_state: creating
          on-success:
            - create_ConsulServerDC2
        create_ConsulServerDC2:
          node: ConsulServerDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulServerDC2_created
        ConsulServerDC2_created:
          node: ConsulServerDC2
          activity:
            set_state: created
          on-success:
            - ConsulServerDC2_configuring
        ConsulServerDC2_configuring:
          node: ConsulServerDC2
          activity:
            set_state: configuring
          on-success:
            - pre_conf_ConsulServerDC2/1
        pre_conf_ConsulServerDC2/1:
          node: ConsulServerDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Configure.pre_configure_source/1
          on-success:
            - configure_ConsulServerDC2
        configure_ConsulServerDC2:
          node: ConsulServerDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulServerDC2_configured
        ConsulServerDC2_configured:
          node: ConsulServerDC2
          activity:
            set_state: configured
          on-success:
            - ConsulServerDC2_starting
        ConsulServerDC2_starting:
          node: ConsulServerDC2
          activity:
            set_state: starting
          on-success:
            - start_ConsulServerDC2
        start_ConsulServerDC2:
          node: ConsulServerDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulServerDC2_started
        ConsulServerDC2_started:
          node: ConsulServerDC2
          activity:
            set_state: started
          on-success:
            - ConsulAgentDC2_configuring
    uninstall:
      steps:
        NetworkDC1_uninstall:
          node: NetworkDC1
          activity:
            delegate: uninstall
        FIPConsulServerDC1_uninstall:
          node: FIPConsulServerDC1
          activity:
            delegate: uninstall
        ComputeConsulServerDC1_uninstall:
          node: ComputeConsulServerDC1
          activity:
            delegate: uninstall
          on-success:
            - FIPConsulServerDC1_uninstall
            - NetworkDC1_uninstall
        ComputeConsulAgentDC1_uninstall:
          node: ComputeConsulAgentDC1
          activity:
            delegate: uninstall
          on-success:
            - NetworkDC1_uninstall
        ConsulAgentDC1_stopping:
          node: ConsulAgentDC1
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulAgentDC1
        stop_ConsulAgentDC1:
          node: ConsulAgentDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulAgentDC1_stopped
        ConsulAgentDC1_stopped:
          node: ConsulAgentDC1
          activity:
            set_state: stopped
          on-success:
            - ConsulAgentDC1_deleting
        ConsulAgentDC1_deleting:
          node: ConsulAgentDC1
          activity:
            set_state: deleting
          on-success:
            - ConsulAgentDC1_deleted
        ConsulAgentDC1_deleted:
          node: ConsulAgentDC1
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulAgentDC1_uninstall
        ConsulServerDC1_stopping:
          node: ConsulServerDC1
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulServerDC1
        stop_ConsulServerDC1:
          node: ConsulServerDC1
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulServerDC1_stopped
        ConsulServerDC1_stopped:
          node: ConsulServerDC1
          activity:
            set_state: stopped
          on-success:
            - ConsulServerDC1_deleting
        ConsulServerDC1_deleting:
          node: ConsulServerDC1
          activity:
            set_state: deleting
          on-success:
            - ConsulServerDC1_deleted
        ConsulServerDC1_deleted:
          node: ConsulServerDC1
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulServerDC1_uninstall
        NetworkDC2_uninstall:
          node: NetworkDC2
          activity:
            delegate: uninstall
        FIPConsulServerDC2_uninstall:
          node: FIPConsulServerDC2
          activity:
            delegate: uninstall
        ComputeConsulServerDC2_uninstall:
          node: ComputeConsulServerDC2
          activity:
            delegate: uninstall
          on-success:
            - FIPConsulServerDC2_uninstall
            - NetworkDC2_uninstall
        ComputeConsulAgentDC2_uninstall:
          node: ComputeConsulAgentDC2
          activity:
            delegate: uninstall
          on-success:
            - NetworkDC2_uninstall
        ConsulAgentDC2_stopping:
          node: ConsulAgentDC2
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulAgentDC2
        stop_ConsulAgentDC2:
          node: ConsulAgentDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulAgentDC2_stopped
        ConsulAgentDC2_stopped:
          node: ConsulAgentDC2
          activity:
            set_state: stopped
          on-success:
            - ConsulAgentDC2_deleting
        ConsulAgentDC2_deleting:
          node: ConsulAgentDC2
          activity:
            set_state: deleting
          on-success:
            - ConsulAgentDC2_deleted
        ConsulAgentDC2_deleted:
          node: ConsulAgentDC2
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulAgentDC2_uninstall
        ConsulServerDC2_stopping:
          node: ConsulServerDC2
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulServerDC2
        stop_ConsulServerDC2:
          node: ConsulServerDC2
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulServerDC2_stopped
        ConsulServerDC2_stopped:
          node: ConsulServerDC2
          activity:
            set_state: stopped
          on-success:
            - ConsulServerDC2_deleting
        ConsulServerDC2_deleting:
          node: ConsulServerDC2
          activity:
            set_state: deleting
          on-success:
            - ConsulServerDC2_deleted
        ConsulServerDC2_deleted:
          node: ConsulServerDC2
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulServerDC2_uninstall
