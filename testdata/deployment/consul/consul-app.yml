tosca_definitions_version: tosca_simple_yaml_1_0_0_wd03
description: Alien4Cloud generated service template
template_name: Test
template_version: 0.1.0-SNAPSHOT
template_author: admin

imports:
  - openstack-types: <janus-openstack-types.yml>
  - consul-types: consul/consul-types.yaml

topology_template:
  node_templates:
    ConsulAgent:
      type: starlings.nodes.Consul
      properties:
        install_dnsmasq: true
        installation_directory: ~/consul
        component_version: 0.5.2
      requirements:
        - host:
            node: ComputeConsulAgent
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
        - server_endpoint:
            node: ConsulServer
            capability: starlings.capabilities.ConsulServer
            relationship: starlings.relationships.ConnectsConsulAgentToServer
    ComputeConsulAgent:
      type: janus.nodes.openstack.Compute
      properties:
        user: cloud-user
        flavor: 2
        key_pair: janus
        # Liberty
        image: 4bde6002-649d-4868-a5cb-fcd36d5ffa63
        # IceHouse
#        image: 89ec515c-3251-4c2f-8402-bda280c31650
#        availability_zone: r423-02.share.ops
      requirements:
        - network:
            node: Network
            capability: janus.capabilities.openstack.FIPConnectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: PRIVATE
        scalable:
          properties:
            max_instances: 5
            min_instances: 1
            default_instances: 2
    Network:
      type: janus.nodes.openstack.FloatingIP
      properties:
        # Liberty
        floating_network_name: public-starlings
        # IceHouse
#        floating_network_name: Public_Network
    ConsulServer:
      type: starlings.nodes.Consul
      properties:
        install_dnsmasq: true
        installation_directory: ~/consul
        component_version: 0.5.2
      requirements:
        - host:
            node: ComputeConsulServer
            capability: tosca.capabilities.Container
            relationship: tosca.relationships.HostedOn
    ComputeConsulServer:
      type: janus.nodes.openstack.Compute
      properties:
        user: cloud-user
        flavor: 2
        key_pair: janus
        # Liberty
        image: 4bde6002-649d-4868-a5cb-fcd36d5ffa63
        # IceHouse
#        image: 89ec515c-3251-4c2f-8402-bda280c31650
#        availability_zone: r423-02.share.ops
      requirements:
        - network:
            node: Net
            capability: janus.capabilities.openstack.FIPConnectivity
      capabilities:
        endpoint:
          properties:
            protocol: tcp
            initiator: source
            secure: true
            network_name: PRIVATE
        scalable:
          properties:
            max_instances: 5
            min_instances: 1
            default_instances: 3
    Net:
      type: janus.nodes.openstack.FloatingIP
      properties:
        # Liberty
        floating_network_name: public-starlings
        # IceHouse
#        floating_network_name: Public_Network
  workflows:
    agentsInMaintenance:
      steps:
        ConsulAgent_Maintenance:
          node: ConsulAgent
          activity:
            call_operation: custom.maintenance_on
    install:
      steps:
        Network_install:
          node: Network
          activity:
            delegate: install
          on-success:
            - ComputeConsulAgent_install
        Net_install:
          node: Net
          activity:
            delegate: install
          on-success:
            - ComputeConsulServer_install
        ComputeConsulServer_install:
          node: ComputeConsulServer
          activity:
            delegate: install
          on-success:
            - ConsulServer_initial
        ComputeConsulAgent_install:
          node: ComputeConsulAgent
          activity:
            delegate: install
          on-success:
            - ConsulAgent_initial
        ConsulAgent_initial:
          node: ConsulAgent
          activity:
            set_state: initial
          on-success:
            - ConsulAgent_creating
        ConsulAgent_creating:
          node: ConsulAgent
          activity:
            set_state: creating
          on-success:
            - create_ConsulAgent
        create_ConsulAgent:
          node: ConsulAgent
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulAgent_created
        pre_conf_consulAgent/1:
          node: ConsulAgent
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Configure.pre_configure_source/server_endpoint/ConsulServer
          on-success:
            - configure_ConsulAgent
        ConsulAgent_created:
          node: ConsulAgent
          activity:
            set_state: created
          on-success:
            - ConsulAgent_configuring
            - ConsulServer_configuring
        ConsulAgent_configuring:
          node: ConsulAgent
          activity:
            set_state: configuring
          on-success:
            - pre_conf_consulAgent/1
        configure_ConsulAgent:
          node: ConsulAgent
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulAgent_configured
        ConsulAgent_configured:
          node: ConsulAgent
          activity:
            set_state: configured
          on-success:
            - ConsulAgent_starting
        ConsulAgent_starting:
          node: ConsulAgent
          activity:
            set_state: starting
          on-success:
            - start_ConsulAgent
        start_ConsulAgent:
          node: ConsulAgent
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulAgent_started
        ConsulAgent_started:
          node: ConsulAgent
          activity:
            set_state: started
        ConsulServer_initial:
          node: ConsulServer
          activity:
            set_state: initial
          on-success:
            - ConsulServer_creating
        ConsulServer_creating:
          node: ConsulServer
          activity:
            set_state: creating
          on-success:
            - create_ConsulServer
        create_ConsulServer:
          node: ConsulServer
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.create
          on-success:
            - ConsulServer_created
        ConsulServer_created:
          node: ConsulServer
          activity:
            set_state: created
          on-success:
            - ConsulServer_configuring
        ConsulServer_configuring:
          node: ConsulServer
          activity:
            set_state: configuring
          on-success:
            - configure_ConsulServer
        configure_ConsulServer:
          node: ConsulServer
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.configure
          on-success:
            - ConsulServer_configured
        ConsulServer_configured:
          node: ConsulServer
          activity:
            set_state: configured
          on-success:
            - ConsulServer_starting
        ConsulServer_starting:
          node: ConsulServer
          activity:
            set_state: starting
          on-success:
            - start_ConsulServer
        start_ConsulServer:
          node: ConsulServer
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.start
          on-success:
            - ConsulServer_started
        ConsulServer_started:
          node: ConsulServer
          activity:
            set_state: started
          on-success:
            - ConsulAgent_configuring
    uninstall:
      steps:
        Network_uninstall:
          node: Network
          activity:
            delegate: uninstall
        Net_uninstall:
          node: Net
          activity:
            delegate: uninstall
        ComputeConsulServer_uninstall:
          node: ComputeConsulServer
          activity:
            delegate: uninstall
          on-success:
            - Net_uninstall
        ComputeConsulAgent_uninstall:
          node: ComputeConsulAgent
          activity:
            delegate: uninstall
          on-success:
            - Network_uninstall
        ConsulAgent_stopping:
          node: ConsulAgent
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulAgent
        stop_ConsulAgent:
          node: ConsulAgent
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulAgent_stopped
        ConsulAgent_stopped:
          node: ConsulAgent
          activity:
            set_state: stopped
          on-success:
            - ConsulAgent_deleting
            - ConsulServer_stopping
        ConsulAgent_deleting:
          node: ConsulAgent
          activity:
            set_state: deleting
          on-success:
            - ConsulAgent_deleted
        ConsulAgent_deleted:
          node: ConsulAgent
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulAgent_uninstall
        ConsulServer_stopping:
          node: ConsulServer
          activity:
            set_state: stopping
          on-success:
            - stop_ConsulServer
        stop_ConsulServer:
          node: ConsulServer
          activity:
            call_operation: tosca.interfaces.node.lifecycle.Standard.stop
          on-success:
            - ConsulServer_stopped
        ConsulServer_stopped:
          node: ConsulServer
          activity:
            set_state: stopped
          on-success:
            - ConsulServer_deleting
        ConsulServer_deleting:
          node: ConsulServer
          activity:
            set_state: deleting
          on-success:
            - ConsulServer_deleted
        ConsulServer_deleted:
          node: ConsulServer
          activity:
            set_state: deleted
          on-success:
            - ComputeConsulServer_uninstall
